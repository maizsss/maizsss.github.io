<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    <title>headlesschrome封装库puppeteer的运用 | maizsss blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="">
    <meta name="description" content="介绍一下puppeteer 官方说明 Puppeteer is a Node library which provides a high-level API to control headless Chrome or Chromium over the DevTools Protocol. It can also be configured to use full (non-headless) C">
<meta property="og:type" content="article">
<meta property="og:title" content="headlesschrome封装库puppeteer的运用">
<meta property="og:url" content="http://maizsss.github.io/2018/06/11/headlesschrome封装库puppeteer的运用/index.html">
<meta property="og:site_name" content="maizsss blog">
<meta property="og:description" content="介绍一下puppeteer 官方说明 Puppeteer is a Node library which provides a high-level API to control headless Chrome or Chromium over the DevTools Protocol. It can also be configured to use full (non-headless) C">
<meta property="og:updated_time" content="2018-06-14T07:35:00.664Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="headlesschrome封装库puppeteer的运用">
<meta name="twitter:description" content="介绍一下puppeteer 官方说明 Puppeteer is a Node library which provides a high-level API to control headless Chrome or Chromium over the DevTools Protocol. It can also be configured to use full (non-headless) C">
    
        <link rel="alternate" type="application/atom+xml" title="maizsss blog" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu"  >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">maizsss</h5>
          <a href="mailto:413750188@qq.com" title="413750188@qq.com" class="mail">413750188@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">headlesschrome封装库puppeteer的运用</div>
        
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">headlesschrome封装库puppeteer的运用</h1>
        <h5 class="subtitle">
            
                <time datetime="2018-06-11T06:27:47.000Z" itemprop="datePublished" class="page-time">
  2018-06-11
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#介绍一下puppeteer"><span class="post-toc-text">介绍一下puppeteer</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#使用方式"><span class="post-toc-text">使用方式</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#基本用法"><span class="post-toc-text">基本用法</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#linux环境下使用"><span class="post-toc-text">linux环境下使用</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#使用场景"><span class="post-toc-text">使用场景</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#作为ui自动化测试的浏览器框架"><span class="post-toc-text">作为ui自动化测试的浏览器框架</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#自动网页截图发送"><span class="post-toc-text">自动网页截图发送</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#SPA项目的爬虫"><span class="post-toc-text">SPA项目的爬虫</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#服务端渲染"><span class="post-toc-text">服务端渲染</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#一点思考"><span class="post-toc-text">一点思考</span></a></li></ol>
        </nav>
    </aside>
    
<article id="post-headlesschrome封装库puppeteer的运用"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">headlesschrome封装库puppeteer的运用</h1>
        <div class="post-meta">
            <time class="post-time" title="2018-06-11 14:27:47" datetime="2018-06-11T06:27:47.000Z"  itemprop="datePublished">2018-06-11</time>

            


            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h2 id="介绍一下puppeteer"><a href="#介绍一下puppeteer" class="headerlink" title="介绍一下puppeteer"></a>介绍一下puppeteer</h2><ul>
<li><a href="https://github.com/GoogleChrome/puppeteer" target="_blank" rel="external">官方说明</a><blockquote>
<p>Puppeteer is a Node library which provides a high-level API to control headless Chrome or Chromium over the DevTools Protocol. It can also be configured to use full (non-headless) Chrome or Chromium.</p>
</blockquote>
</li>
<li>我练习一下翻译<blockquote>
<p>Puppeteer是一个提供了高级api（高层封装）可以操作headless Chrome和基于Chromium的开发者工具协议的nodejs库。它能被设置为无头模式的chrome和chromium。</p>
</blockquote>
</li>
<li>通俗点说的就是，我们可以用Puppeteer这个nodejs库来操作一个浏览器（chrome）。</li>
<li>在Puppeteer之前，我们如果需要做一些自动化浏览器的事情，很容易会想到PhantomJS，或者nightmare。然而听说了Puppeteer出来之后，PhantomJS直接放弃维护了（真假不清楚，听说的）。而之前一直在用nightmare的开发者，听说过Puppeteer之后，也换阵营了（比如说本人，还有ant design pro的UI e2e测试方案，详见<a href="https://pro.ant.design/docs/changelog-cn" target="_blank" rel="external">#1006的更新日志</a>）。</li>
<li>在粗略翻了一下官方的<a href="https://github.com/GoogleChrome/puppeteer/blob/v1.4.0/docs/api.md" target="_blank" rel="external">api文档</a>之后，就能发现Puppeteer的功能之广，涵盖到“跳转页面、点击、dom元素检查、js脚本注入”的基本操作，也有“截图”、“PDF”、“性能”、“请求、响应”、“移动端事件”等能想到的浏览器功能。PhantomJS能做到的一些爬虫功能，Puppeteer能轻松应对，而且提供了更多的其余功能，更高的运行性能。而nightmare因为基于electron，electron本身也个强大的框架，所以nightmare在其之上还算是有一定的抵抗力。对比背后团队，puppeteer是GoogleChrome支撑开源的，项目维护实力无需担心。<h2 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h2><h3 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h3></li>
<li><p>npm安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm i puppeteer</div></pre></td></tr></table></figure>
</li>
<li><p>hello world</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">/* example.js */</div><div class="line"></div><div class="line">const puppeteer = require(&apos;puppeteer&apos;); // 引入puppeteer</div><div class="line"></div><div class="line">(async () =&gt; &#123;</div><div class="line">  const browser = await puppeteer.launch();// 实例化一个浏览器对象</div><div class="line">  const page = await browser.newPage();// 调起一个新的页面</div><div class="line">  await page.goto(&apos;https://example.com&apos;);// 跳转到一个url</div><div class="line">  await page.screenshot(&#123;path: &apos;example.png&apos;&#125;);// 对当前页面进行截图</div><div class="line"></div><div class="line">  await browser.close();// 关闭一个浏览器对象</div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
</li>
<li><p>运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">node example.js</div></pre></td></tr></table></figure>
</li>
<li><p>以上是官网上的代码例子，更多的不再说，请详细翻阅api文档和其他的使用例子。但从这几行代码可以看出，puppeteer的api从理解上和使用上都十分地友好，基本上遵循了我们平时对chrome的使用习惯。</p>
</li>
<li>另外，可以清楚的是，puppeteer运行在nodejs平台，作为一个npm包去引入，与npm强大的生态资源配合起来使用，可以做很多事情。<h3 id="linux环境下使用"><a href="#linux环境下使用" class="headerlink" title="linux环境下使用"></a>linux环境下使用</h3></li>
<li>一般来说，我们会在windows或者mac系统下使用chrome。而linux，对于像chrome这样的GUI应用程序来说并不合适在其之上运行。然而还是有方式。</li>
<li>当npm安装puppeteer时，会默认安装了chromium。但安装了chromium并不意味着马上就可以在linux上运行，因为还缺少一些依赖。</li>
<li><p>以centos7为例，需要执行以下命令安装一系列依赖。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// 依赖库</div><div class="line">yum install pango.x86_64 libXcomposite.x86_64 libXcursor.x86_64 libXdamage.x86_64 libXext.x86_64 libXi.x86_64 libXtst.x86_64 cups-libs.x86_64 libXScrnSaver.x86_64 libXrandr.x86_64 GConf2.x86_64 alsa-lib.x86_64 atk.x86_64 gtk3.x86_64 -y</div></pre></td></tr></table></figure>
</li>
<li><p>安装这些依赖成功后，就可以让puppeteer以headless模式运行了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// 字体</div><div class="line">yum install ipa-gothic-fonts xorg-x11-fonts-100dpi xorg-x11-fonts-75dpi xorg-x11-utils xorg-x11-fonts-cyrillic xorg-x11-fonts-Type1 xorg-x11-fonts-misc -y</div></pre></td></tr></table></figure>
</li>
<li><p>除此之外，当你对一些页面进行截图时会发现，有些汉字显示不完整，这是因为缺少了中文字体库和一些字库依赖。那就安装一下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">// 中文字体适配</div><div class="line">yum groupinstall &quot;Chinese Support&quot;</div><div class="line">yum groupinstall &quot;Font&quot;</div></pre></td></tr></table></figure>
</li>
<li><p>至此，puppeteer就能运行在linux下了。</p>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2></li>
<li>在官网上，已经列出了几条puppeteer的主要使用方式。<ul>
<li>Generate screenshots and PDFs of pages.<br>Crawl a SPA and generate pre-rendered content (i.e. “SSR”).</li>
<li>Automate form submission, UI testing, keyboard input, etc.</li>
<li>Create an up-to-date, automated testing environment. Run your tests directly in the latest version of Chrome using the latest JavaScript and browser features.</li>
<li>Capture a timeline trace of your site to help diagnose performance issues.</li>
</ul>
</li>
<li>我在实际使用中，也参考了这几点去实践了。下面大概说说。<h3 id="作为ui自动化测试的浏览器框架"><a href="#作为ui自动化测试的浏览器框架" class="headerlink" title="作为ui自动化测试的浏览器框架"></a>作为ui自动化测试的浏览器框架</h3></li>
<li>在UI自动化测试这个事情上面，之前我有总结过一个博文：<a href="https://maizsss.github.io/2017/10/28/%E5%89%8D%E7%AB%AF%E7%9A%84UI%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/">点击跳转</a>。所以不再细说。</li>
<li>这次我把以上博文中的nightmare换成了puppeteer，也就是只把自动化浏览器框架调换了，其他技术构成基本保持一致。</li>
<li>此外，我还利用这套UI自动化测试去做了“页面监控”这样的事情。这里不再展开，有兴趣可以私下讨论。<h3 id="自动网页截图发送"><a href="#自动网页截图发送" class="headerlink" title="自动网页截图发送"></a>自动网页截图发送</h3></li>
<li>以上代码例子中就有用到了screenshot这个api，网页截图就是基于这个api开展。仔细看<a href="https://github.com/GoogleChrome/puppeteer/blob/v1.4.0/docs/api.md#pagescreenshotoptions" target="_blank" rel="external">screenshot的文档</a>,还能发现它支持“全屏”、“图片类型、质量指定”、“裁剪”。</li>
<li>要做成这个功能，需要用到nodejs的其他一些工具库，比如说“定时任务”、“邮件发送（或其他消息通知类工具）”、“打包压缩”。是一个puppeteer很好的工具配合使用的实践。</li>
</ul>
<h3 id="SPA项目的爬虫"><a href="#SPA项目的爬虫" class="headerlink" title="SPA项目的爬虫"></a>SPA项目的爬虫</h3><ul>
<li>SPA（单页面web应用）在页面渲染上面用的都是js异步渲染，与传统服务端渲染直接吐出完整的html内容不同。所以一些旧的爬虫工具已经不太适合使用在SPA项目上面了。</li>
<li>而puppeteer因为是一个chromium内核的浏览器工具，固然能抓取到所有能在页面正常渲染的内容，无论是html还是基于js的异步加载。</li>
<li>puppeteer本身支持单个浏览器对象的多开页面，所以在共享登录态这类场景下毫无压力。视硬件配置而定，甚至能多开浏览器实例，做并发爬虫。</li>
</ul>
<h3 id="服务端渲染"><a href="#服务端渲染" class="headerlink" title="服务端渲染"></a>服务端渲染</h3><ul>
<li>也是因为puppeteer能抓取到所有能在页面正常渲染的内容，换个方向去想，其实也能在抓取这些内容后生成完整的html内容。</li>
<li>猜想而已。一个SPA项目，在webserver层判断当下请求是否需要一个完整的html内容（比如百度爬虫），是的话就通过puppeteer抓取对应页面的内容后生成html返回（这里可以适当做一下缓存）。不是的话，就返回SPA页面。</li>
</ul>
<h2 id="一点思考"><a href="#一点思考" class="headerlink" title="一点思考"></a>一点思考</h2><ul>
<li>其实不止nightmare、puppeteer，另外还有一个叫<a href="https://github.com/prismagraphql/chromeless" target="_blank" rel="external">chromeless</a>的库，也是在做着类似的事情。也是基于headless chrome的库。我也花了时间去做调研对比。</li>
<li>这是当下这个前端时期的精彩和焦虑。客户端配置越来越高，让js的性能发挥得越来越好，js的跨平台特性，让它可以在各个领域都能开花，这是精彩。而焦虑的是，各种层出不穷的技术快速映入开发者的视野，作为js使用者我们不能避而不看。而又有很多的技术框架其实是功能类似的，我们要如何在这当中选择最合适的来使用，很可能会让我们要在这中间来回跳转好几次。</li>
<li>利弊都有，而在我内心还是十分感激js开源社区中活跃的前辈们赋予了我们很多的工具，很多的能力，让我们能做更多的事情，改善工作，改善生活。</li>
</ul>

        </div>

        <blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    Last updated: <time datetime="2018-06-14T07:35:00.664Z" itemprop="dateUpdated">2018-06-14 15:35:00</time>
</span><br>


        
    </div>
    <footer>
        <a href="http://maizsss.github.io">
            <img src="/img/avatar.jpg" alt="maizsss">
            maizsss
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            

            


        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between flex-row-reverse">
  

  
    <div class="waves-block waves-effect next">
      <a href="/2018/05/07/从nodejs的stream说起/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">从nodejs的stream说起</h4>
      </a>
    </div>
  
</nav>



    











</article>



</div>

        <footer class="footer">
    <!-- <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>This blog is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</span>
        </p>
    </div> -->
    <div class="bottom">
        <p><span>maizsss &copy; 2015 - 2018</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>


    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: false, REWARD: false };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>






<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = '额~~~~';
            clearTimeout(titleTime);
        } else {
            document.title = 'maizsss blog';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
